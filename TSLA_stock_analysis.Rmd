---
title: "Econ144 Project1"
author: "Aditya Gorla"
date: "4/24/2019"
output: html_document
---

##\n\n

```{r setup, include=FALSE}
rm(list=ls(all=TRUE))

library(car)
require(stats)
require(stats4)
library(MASS)
library(knitr)
library(tseries)
library(forecast)
library(moments)
library("readxl")
library(dynlm)
library(zoo)
library("TTR")
library(rlist)
library(tstools)
library(datasets)
library(fpp2)
library(seasonal)
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction
With the recent developments in electric car technology as well as battery research, companies who entered the game early should have been able to capitalize on these factors. One of the first companies that come to mind would be Tesla. Companies closely associated with Tesla have been making headlines in recent years as well, such as SpaceX and the Boring Company. We wanted to look at these recent developments and see if this stock is promising.

##\n\n

We chose to model and forecast the weekly adjusted closing price of Tesla stock over a 9 year period. We chose weekly data over daily data to avoid short term noise in higher frequency trading, as well as to accurate measure trend and seasonality.


##\n\n

### Results

#### Initial Data Exploration

```{r results='hold',message=FALSE}
#Loading the data
tsla<-read.table("TSLA.csv", header=TRUE, sep=",")
names(tsla)=c("date","open","high","low","close","adjClose","Volume")
attach(tsla)
#we'll be working with adjusted closing price and the data is weekly
tsla_ts<-ts(tsla$adjClose, start = 2010.5, frequency=52)
t<-seq(length=length(tsla_ts))
t2<-t^2
t3<-t^3
t4<-t^4
t5<-t^5
ltsla_ts<- log(tsla_ts)

plot(tsla_ts, xlab="Year", ylab="Adjusted Closing Price (in $)", main="TSLA Stock")
tsdisplay(tsla_ts, main="TSLA Stock", xlab="Year", ylab="Adjusted Closing Price (in $)")

```

The plot shows that the stock prices are increasing over time. This indicates that the mean is time variant. In addition, The variance changes across time, with variance being relatively flat initially, before undergoing periods of fluctuating volatility. Hence, the data is not covariance stationary.

##\n\n
The ACF shows that the data follows a correlated process, although it decays over time. This indicates that realizations from periods far into the past have less correlation with present realizations.The PACF shows that the spikes are mostly not significant, with only a few spikes exceeding the confidence intervals. Unlike the ACF, the PACF does not seem to decay over time. The ACF and PACF suggest that the series is autoregressive; the ACF gradually decays to zero while the pacf exhibits several major lag spikes, namely at lag 1 and lag 10. We can conclude that an AR model would be best suited for forecasting TESLA stock prices.

##\n\n

#### Initial Model building
```{r results='hold',message=FALSE}
# linear model
lin_m<- dynlm(tsla_ts ~ t)
plot(tsla_ts,lwd=2, col=1, main="TSLA Stock Linear Model Fit", xlab="Year", ylab="Adjusted Closing Price (in $)")
lines(lin_m$fitted.values ,col=2,lwd=2)
legend('bottomright', legend=c("Actual Value", "Linear Model Fit"), col=1:2, lwd=2)

# non-linear model
nl_m<- dynlm(ltsla_ts ~ t + t2 + t3)
plot(ltsla_ts,lwd=2, col="black", main="TSLA Stock Non-Linear Model Fit", xlab="Year", ylab="Log-Adjusted Closing Price (in $)")
lines(nl_m$fitted.values,col='blue3',lwd=2)
legend('bottomright', legend=c("Actual Value", "Non-Linear Model Fit"), col=c("black", "blue3"),lwd=2)
```

##\n\n

#### Initial Model Diagnostics and Selection
```{r results='hold',message=FALSE}

# linear model
plot(y=lin_m$residuals, x=lin_m$fitted.values,lwd=2, col=1, main="TSLA Linear Model", xlab="Fitted Values", ylab="Residuals")
truehist(lin_m$residuals,col='gray80',main="TSLA Linear Model", ylab="Fraction", xlab="Residuals")
summary(lin_m)


# non-linear model
plot(y=nl_m$residuals, x=nl_m$fitted.values,lwd=2, col=1, main="TSLA Non-Linear Model", xlab="Fitted Values", ylab="Residuals")
truehist(nl_m$residuals,col='gray80',main="TSLA Non-Linear Model", ylab="Fraction", xlab="Residuals")
summary(nl_m)

AIC(lin_m,nl_m)

BIC(lin_m,nl_m)
```

For the linear model, the plot of the residuals and the fitted values shows that there is clearly a lot of structure present in the residuals. The residuals seem to go through some seasonality. For the linear model, the plot of the histogram shows that the residuals are centered around 0 and are somewhat symmetric but is skewed. Hence, the normality assumption for the residuals is unlikely to hold.

##\n\n

For the non-linear model, the plot of the residuals and the fitted values shows that there is clearly some structure present in the residuals. The residuals seem to go through some seasonality as well.Compared to the linear model, the plot of the histogram shows that the residuals also centered around 0 but are less symmetric but is skewed. Hence, the normality assumption for the residuals is not to hold as well. However, the scale of the residuals for the non-linear model is significantly smaller compared to the


##\n\n

For the linear model, we have an adjusted R-squared of 0.8562, which means that a relatively high proportion of the stock prices are explained by t. 
The t-value for the coefficient of t also indicates that the estimated coefficient is statistically significant at a confidence level of 95%.
From the F-statistic, we reject the null hypothesis that the coefficient of all the variables is equal to 0.

##\n\n

For the non-linear model, we have an adjusted R-squared of 0.9006, which means that a higher proportion of the stock prices are explained by t, t2 and t3. 
The t-value for the coefficients of t, t2 and t3 also indicates that the estimated coefficient is statistically significant at a confidence level of 95%.
From the F-statistic, we reject the null hypothesis that the coefficient of all the variables is equal to 0.

##\n\n

For AIC, the linear model has a value of 4794, but the non linear model has a much lower value of 275. Hence, based on AIC, we pick the non-linear model. For BIC, the linear model has a value of 4806, but the non linear model has a much lower value of 296 Hence, based on BIC, we pick the non-linear model. Overall, the AIC/BIC suggests that the nonlinear model is better than the linear model with regards to forecasting strength. Hence, both models agree.

##\n\n

#### Non-Linear Model Forcast
We are going to do a 24-steps forcast using our Non-Linear model above. This should predict the weekly Tesla adjusted closing price for the next 6 months.
```{r results='hold',message=FALSE}
plot(predict(nl_m$fitted.values, h=24) ,shadecols="oldstyle", main="TSLA Stock Non-Linear Model Forcast", xlab="Year", ylab="Log-Adjusted Closing Price (in $)", lwd=2, col=1, ylim=c(2.75, 6))
lines(ltsla_ts,lwd=2, col=2)
legend('bottomright', legend=c( "Model+Forcast","Actual Value"), col=1:2, lwd=2)
```

##\n\n

### Modeling and Forecasting Seasonality

#### Initial Data Exploration

```{r results='hold',message=FALSE}
#2a,b,c,d,e: construct a model with a full set set of seasonal dummies, plot the seasonal factors, interpret plot, add trend from problem 1, interpret the summary, do h-step forecast (h>16)
#recall that nl_m<- dynlm(ltsla_ts ~ t + t2 + t3)
seasonal_m<-tslm(ltsla_ts ~ season+0)
plot(seasonal_m$coefficients,xlab="Week",ylab="Seasonal Coefficient")
```
The interpretation of this coefficient plot heavily suggests a pattern in stock price growth; a face-value analysis shows us that prices growth during the first half of each year (weeks 0-26) and then drop abruptly in the second half of the year. A continuation of this plot, however, into the next year, would suggest that growth occurs between ~week 30 of year i and week 30 of year i+1. Overall, the plot suggests a clear upward trend for Tesla stock prices.

```{r results='hold',message=FALSE}
m_final<-tslm(ltsla_ts~0+season+t + t2 + t3)
#then we plot the residuals vs fitted values 
plot(y=m_final$residuals,x=m_final$fitted.values,ylab="Residuals",xlab="fitted values")
```
An observation of the fitted values compared to their residuals demonstrates a periodic trend, roughly equivalent to a sine wave, suggesting that the nonlinear model combined with the seasonal component has not entirely identified the stochastic trend that determines Tesla stock prices.
```{r}
summary(m_final)
```

